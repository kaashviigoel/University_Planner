<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Planner</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background: linear-gradient(135deg, #00f1fe9e 0%, #4facfe95 100%); 
            min-height: 100vh; 
            padding: 20px; 
        }
        .container { 
            max-width: 1200px; 
            margin: 0 auto; 
            background: white; 
            border-radius: 20px; 
            box-shadow: 0 20px 40px rgba(0,0,0,0.1); 
            overflow: hidden; 
        }
        .header { 
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); 
            color: white; 
            padding: 30px; 
            text-align: center; 
        }
        .header h1 { font-size: 2.5em; margin-bottom: 10px; }
        .status { padding: 20px; background: #f0f8ff; text-align: center; font-weight: bold; color: #333; }
        .dashboard { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); 
            gap: 20px; 
            padding: 30px; 
        }
        .card { 
            background: white; 
            border-radius: 15px; 
            padding: 25px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.1); 
        }
        .card h3 { color: #333; margin-bottom: 15px; font-size: 1.3em; }
        .metric { font-size: 2.5em; font-weight: bold; color: #4facfe; }
        .section { padding: 30px; border-bottom: 1px solid #eee; }
        .section:last-child { border-bottom: none; }
        .section h2 { color: #333; margin-bottom: 20px; font-size: 1.8em; }
        button { 
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); 
            color: white; 
            border: none; 
            padding: 12px 24px; 
            border-radius: 25px; 
            cursor: pointer; 
            font-size: 16px; 
            transition: transform 0.2s; 
            margin-right: 10px;
        }
        button:hover { transform: translateY(-2px); }
        .list-container { margin-top: 20px; min-height: 100px; }
        .list-item { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 20px; 
            background: #f8f9ff; 
            border-radius: 12px; 
            margin-bottom: 15px; 
            transition: all 0.3s; 
        }
        .list-item:hover { box-shadow: 0 5px 20px rgba(0,0,0,0.1); transform: translateY(-2px); }
        .list-item.completed { opacity: 0.6; background: #e8f5e8; }
        .switch { 
            position: relative; 
            display: inline-block; 
            width: 60px; 
            height: 34px; 
        }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { 
            position: absolute; 
            cursor: pointer; 
            top: 0; 
            left: 0; 
            right: 0; 
            bottom: 0; 
            background-color: #ccc; 
            transition: .4s; 
            border-radius: 34px; 
        }
        .slider:before { 
            position: absolute; 
            content: ""; 
            height: 26px; 
            width: 26px; 
            left: 4px; 
            bottom: 4px; 
            background-color: white; 
            transition: .4s; 
            border-radius: 50%; 
        }
        input:checked + .slider { background-color: #4facfe; }
        input:checked + .slider:before { transform: translateX(26px); }
        .delete-btn { 
            background: #ff6b6b; 
            margin-left: 10px; 
            padding: 10px 12px; 
            font-size: 14px; 
        }
        .modal { 
            display: none; 
            position: fixed; 
            z-index: 1000; 
            left: 0; 
            top: 0; 
            width: 100%; 
            height: 100%; 
            background-color: rgba(0,0,0,0.5); 
        }
        .modal-content { 
            background-color: white; 
            margin: 10% auto; 
            padding: 30px; 
            border-radius: 15px; 
            width: 90%; 
            max-width: 500px; 
            position: relative; 
        }
        .close { 
            position: absolute; 
            right: 20px; 
            top: 15px; 
            font-size: 28px; 
            font-weight: bold; 
            cursor: pointer; 
            color: #aaa; 
        }
        .close:hover { color: #000; }
        form { display: flex; flex-direction: column; gap: 15px; }
        input, select { 
            padding: 15px; 
            border: 2px solid #eee; 
            border-radius: 10px; 
            font-size: 16px; 
        }
        input:focus, select:focus { 
            outline: none; 
            border-color: #4facfe; 
        }
        .error { color: #ff6b6b; padding: 10px; background: #ffe6e6; border-radius: 8px; margin: 10px 0; }
        @media (max-width: 768px) { 
            .dashboard { grid-template-columns: 1fr; } 
            .list-item { flex-direction: column; align-items: flex-start; gap: 15px; } 
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìö Student Planner</h1>
            <p>Track attendance, assignments & stay organized</p>
        </div>

        <div class="status" id="status">Connecting to backend...</div>

        <div class="dashboard" id="dashboard">
            <!-- Dashboard cards load here -->
        </div>

        <div class="section">
            <h2>üìñ Subjects</h2>
            <button onclick="showAddSubjectModal()">+ Add Subject</button>
            <div id="subjects-list" class="list-container">
                <p>Loading subjects...</p>
            </div>
        </div>

        <div class="section">
            <h2>üìã Assignments</h2>
            <button onclick="showAddAssignmentModal()">+ Add Assignment</button>
            <div id="assignments-list" class="list-container">
                <p>Loading assignments...</p>
            </div>
        </div>
    </div>

    <!-- Subject Modal -->
    <div id="add-subject-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeAddSubjectModal()">&times;</span>
            <h3>Add Subject</h3>
            <div id="subject-error" class="error" style="display:none;"></div>
            <form id="add-subject-form">
                <input type="text" id="subject-code" placeholder="Subject Code (e.g. CS101)" required>
                <input type="text" id="subject-name" placeholder="Subject Name" required>
                <input type="text" id="subject-professor" placeholder="Professor Name" required>
                <input type="number" id="subject-attendance" placeholder="Attendance (0)" value="0" min="0">
                <input type="number" id="subject-total" placeholder="Total Classes (0)" value="0" min="0">
                <button type="submit">Add Subject</button>
            </form>
        </div>
    </div>

    <!-- Assignment Modal -->
    <div id="add-assignment-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeAddAssignmentModal()">&times;</span>
            <h3>Add Assignment</h3>
            <div id="assignment-error" class="error" style="display:none;"></div>
            <form id="add-assignment-form">
                <select id="assignment-subject" required>
                    <option value="">Select Subject</option>
                </select>
                <input type="text" id="assignment-title" placeholder="Assignment Title" required>
                <input type="date" id="assignment-deadline" required>
                <button type="submit">Add Assignment</button>
            </form>
        </div>
    </div>

    <script>
        const API_BASE = 'http://127.0.0.1:8000/api';  // Backend URL
        
        // Test backend connection first
        async function testConnection() {
            try {
                const response = await fetch(`${API_BASE}/subjects`);
                if (response.ok) {
                    document.getElementById('status').innerHTML = '‚úÖ Backend connected! Loading data...';
                    setTimeout(() => {
                        document.getElementById('status').style.display = 'none';
                        loadAllData();
                    }, 1500);
                }
            } catch (e) {
                document.getElementById('status').innerHTML = '‚ùå Backend not running. Start <code>python app.py</code> on port 8000';
                document.getElementById('status').style.color = '#ff6b6b';
            }
        }

        async function loadAllData() {
            loadDashboard();
            loadSubjects();
            loadAssignments();
        }

        async function loadDashboard() {
            try {
                const response = await fetch(`${API_BASE}/dashboard`);
                const data = await response.json();
                const dashboard = document.getElementById('dashboard');
                dashboard.innerHTML = `
                    <div class="card">
                        <h3>Today's Classes</h3>
                        ${data.today_classes.map(c => `<div>${c.code} - ${c.name}<br><small>${c.professor}</small></div>`).join('') || '<p>No classes today</p>'}
                    </div>
                    <div class="card">
                        <h3>Low Attendance</h3>
                        <div class="metric">${data.low_attendance}</div>
                        <small>subjects need attention</small>
                    </div>
                    <div class="card">
                        <h3>Upcoming Assignments</h3>
                        ${data.upcoming_assignments.map(a => `<div>${a.title}<br><small>${a.subject_code}</small></div>`).join('') || '<p>All caught up!</p>'}
                    </div>
                    <div class="card">
                        <h3>Total Subjects</h3>
                        <div class="metric">${data.total_subjects}</div>
                    </div>
                `;
            } catch (e) {
                console.error('Dashboard error:', e);
            }
        }

        async function loadSubjects() {
            try {
                const response = await fetch(`${API_BASE}/subjects`);
                const subjects = await response.json();
                const list = document.getElementById('subjects-list');
                list.innerHTML = subjects.map(s => `
                    <div class="list-item">
                        <div>
                            <strong>${s.code} - ${s.name}</strong><br>
                            <small>Prof: ${s.professor}</small><br>
                            <small>Attendance: ${s.attendance}/${s.total_classes} (${s.attendance_pct}%)</small>
                        </div>
                        <div>
                            <button onclick="updateAttendance(${s.id}, 'increment')">+</button>
                            <button onclick="updateAttendance(${s.id}, 'decrement')">-</button>
                            <button onclick="deleteSubject(${s.id})" class="delete-btn">üóëÔ∏è</button>
                        </div>
                    </div>
                `).join('') || '<p>No subjects added yet</p>';
            } catch (e) {
                console.error('Subjects error:', e);
            }
        }

        async function loadAssignments() {
            try {
                const response = await fetch(`${API_BASE}/assignments`);
                const assignments = await response.json();
                const list = document.getElementById('assignments-list');
                list.innerHTML = assignments.map(a => `
                    <div class="list-item ${a.completed ? 'completed' : ''}">
                        <div>
                            <strong>${a.title}</strong><br>
                            <small>${a.subject_code} - ${a.subject_name}</small><br>
                            <small>Due: ${new Date(a.deadline).toLocaleDateString()}</small>
                        </div>
                        <div>
                            <label class="switch">
                                <input type="checkbox" ${a.completed ? 'checked' : ''} onchange="toggleAssignment(${a.id}, this.checked)">
                                <span class="slider"></span>
                            </label>
                            <button onclick="deleteAssignment(${a.id})" class="delete-btn">üóëÔ∏è</button>
                        </div>
                    </div>
                `).join('') || '<p>No assignments yet</p>';
            } catch (e) {
                console.error('Assignments error:', e);
            }
        }

        // Subject functions
        function showAddSubjectModal() {
            document.getElementById('add-subject-modal').style.display = 'block';
            document.getElementById('subject-error').style.display = 'none';
        }
        function closeAddSubjectModal() {
            document.getElementById('add-subject-modal').style.display = 'none';
            document.getElementById('add-subject-form').reset();
        }

        document.getElementById('add-subject-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const errorDiv = document.getElementById('subject-error');
            try {
                const data = {
                    code: document.getElementById('subject-code').value,
                    name: document.getElementById('subject-name').value,
                    professor: document.getElementById('subject-professor').value,
                    attendance: parseInt(document.getElementById('subject-attendance').value) || 0,
                    total_classes: parseInt(document.getElementById('subject-total').value) || 0
                };
                const response = await fetch(`${API_BASE}/subjects`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });
                if (!response.ok) throw new Error(await response.text());
                closeAddSubjectModal();
                loadSubjects();
                loadDashboard();
            } catch (e) {
                errorDiv.textContent = e.message;
                errorDiv.style.display = 'block';
            }
        });

        async function updateAttendance(subjectId, action) {
            try {
                await fetch(`${API_BASE}/subjects/${subjectId}/attendance`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({action})
                });
                loadSubjects();
                loadDashboard();
            } catch (e) {
                console.error('Attendance update failed:', e);
            }
        }

        async function deleteSubject(subjectId) {
            if (confirm('Delete this subject?')) {
                await fetch(`${API_BASE}/subjects/${subjectId}`, {method: 'DELETE'});
                loadSubjects();
                loadDashboard();
            }
        }

        // Assignment functions
        async function showAddAssignmentModal() {
            try {
                const subjectsRes = await fetch(`${API_BASE}/subjects`);
                const subjects = await subjectsRes.json();
                const select = document.getElementById('assignment-subject');
                select.innerHTML = '<option value="">Select Subject</option>' + 
                    subjects.map(s => `<option value="${s.id}">${s.code} - ${s.name}</option>`).join('');
                document.getElementById('add-assignment-modal').style.display = 'block';
                document.getElementById('assignment-error').style.display = 'none';
            } catch (e) {
                console.error('Load subjects for assignment failed:', e);
            }
        }

        function closeAddAssignmentModal() {
            document.getElementById('add-assignment-modal').style.display = 'none';
            document.getElementById('add-assignment-form').reset();
        }

        document.getElementById('add-assignment-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const errorDiv = document.getElementById('assignment-error');
            try {
                const data = {
                    subject_id: parseInt(document.getElementById('assignment-subject').value),
                    title: document.getElementById('assignment-title').value,
                    deadline: document.getElementById('assignment-deadline').value
                };
                await fetch(`${API_BASE}/assignments`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });
                closeAddAssignmentModal();
                loadAssignments();
                loadDashboard();
            } catch (e) {
                errorDiv.textContent = e.message;
                errorDiv.style.display = 'block';
            }
        });

        async function toggleAssignment(id, completed) {
            await fetch(`${API_BASE}/assignments/${id}`, {
                method: 'PUT',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({completed: completed ? 1 : 0})
            });
            loadAssignments();
            loadDashboard();
        }

        async function deleteAssignment(id) {
            if (confirm('Delete this assignment?')) {
                await fetch(`${API_BASE}/assignments/${id}`, {method: 'DELETE'});
                loadAssignments();
                loadDashboard();
            }
        }

        // Start app
        window.onload = testConnection;
    </script>
</body>
</html>
